pipeline {
    agent any
    

    tools{ //herramientas utilizadas para la ejecucion, previamente configuradas
        gradle 'gradle_7-0'
    }
    environment { //parametros
        TAG = "${params.TAG}"
    }
    
    stages{  //etapas, se define el trabajo del pipeline dividido en bloques stage
        stage('git clone'){
            steps{
                //clono el repositorio desde Github
                git branch: 'main', url: 'https://github.com/mbelengonzalez168/Framework_Academia_Tsoft.git'
            }
        }
        stage('Xvfb') {
            steps {
                sh 'Xvfb :99 -ac -screen 0 1280x1024x24 & export DISPLAY=$DISPLAY'
            }
        }
        stage('exec gradle'){
            steps{
                //imprimo la version de graddle
                sh 'gradle --version'
                sh 'gradle runWithCucumber -P tags="@$TAG"' //${tag)} utilizacion del parametro
                sh 'ls'
            }
        }
        stage('load test execution'){ // Intregracion con jenkins instrucciones de conexion
            steps {
                echo "xray"
                echo "Generando token"
                sh 'token=$(curl -H "Content-Type: application/json" -X POST --data @"cloud_auth.json" https://xray.cloud.getxray.app/api/v2/authenticate| tr -d '"')'
                echo "Token Generado: $token"
                echo "Cargando TestExecution"
                Testexecution=$(curl -H "Content-Type: multipart/form-data" -X POST -F info=@info.json -F results=@results/Cucumber.json -H "Authorization: Bearer $token" https://xray.cloud.getxray.app/api/v2/import/execution/cucumber/multipart)
                key=$(echo "$Testexecution" | jq -r '.key')
                curl -D- -X POST "https://smoke-test-pj.atlassian.net/rest/api/3/issue/$key/attachments" -H 'X-Atlassian-Token: no-check' -F "file=@results/reporteQA.pdf" -H 'application/octet-stream' -H 'Authorization: Basic QVRBVFQzeEZmR0YwMVdPa0wzamk1MWMzSnp0NjRnZ3otOHdCUXNjUkZ6Mm5XUG5QdExwMVlURXE0eU44ak4yWW5IdFN2WXJ5RGt4NzI1aFhDeDh6WWVGWDFnbEdzbXdwZ3Y4dF9lcUhjd1NScGNDc1p3ajlOWnUzbVRHRDZ6RF9LWFc0Q2IzMXRzbjh5MTVfVVRYdVJpeThtWnN2Z0RqV2ExRzluWXRkSkxWUFNxc29XZjJFcFA0PUFBRjM2MkZE'
            }
        }
}